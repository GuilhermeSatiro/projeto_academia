<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Edição de Aluno</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    
    </head>
<body class="bg-light min-vh-100 d-flex flex-column">
    <div id="menu"></div>

    <main id="principal" class="container-fluid flex-fill d-flex align-items-start justify-content-center py-4">
        <div class="card shadow p-4 w-100">
            <h2 class="mb-4">Aluno - Editar</h2>
            
            <form id="formEdicao">
                <div class="mb-3">
                    <button type="button" class="btn btn-primary me-2" onclick="window.location.href = 'aluno_listar.html'">Voltar</button>
                    <button type="button" id="btnGravar" class="btn btn-success me-2">Gravar Alterações</button>
                </div>

                <div class="mb-3">
                    <label for="id" class="form-label">ID (Firebase)</label>
                    <input type="text" id="id" name="id" class="form-control" readonly disabled>
                </div>
                <div class="mb-3">
                    <label for="nome" class="form-label">Nome completo</label>
                    <input type="text" id="nome" name="nome" class="form-control" required>
                </div>
                <div class="mb-3">
                    <label for="email" class="form-label">Email</label>
                    <input type="email" id="email" name="email" class="form-control" required>
                </div>
                <div class="mb-3">
                    <label for="login" class="form-label">Login</label>
                    <input type="text" id="login" name="login" class="form-control" required>
                </div>
                <div class="mb-3">
                    <label for="senha" class="form-label">Senha</label>
                    <input type="password" id="senha" name="senha" class="form-control" required>
                </div>
                
                <div class="mb-3">
                    <label for="perfil" class="form-label">Pefil de acesso</label>
                    <select id="perfil" name="perfil" class="form-select" required>
                        <option value="">Selecione</option>
                        <option value="Instrutor">Instrutor</option>
                        <option value="Aluno">Aluno</option>
                    </select>
                </div>
            </form>
        </div>
    </main>

    <div id="rodape"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.7/firebase-app.js";
        import { getFirestore, doc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/9.6.7/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyD9C8wbh4jwaYLHuH5GSAn5hWKxCXjg6Ag",
            authDomain: "trabalho-faculdade-7fee6.firebaseapp.com",
            projectId: "trabalho-faculdade-7fee6",
            storageBucket: "trabalho-faculdade-7fee6.firebasestorage.app",
            messagingSenderId: "681763783199",
            appId: "1:681763783199:web:edd45fdff695a44f310b2a",
            measurementId: "G-F37XKMBDJT"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let alunoId = null;

        document.addEventListener("DOMContentLoaded", async function() {
            
            const urlParams = new URLSearchParams(window.location.search);
            alunoId = urlParams.get('id');

            if (!instrutorId) {
                alert("ID do aluno não encontrado! Voltando para a lista.");
                window.location.href = 'aluno_listar.html';
                return;
            }

            try {
                const docRef = doc(db, "alunos", alunoId);
                const docSnap = await getDoc(docRef);

                if (docSnap.exists()) {
                    const data = docSnap.data();
                    document.getElementById('id').value = docSnap.id;
                    document.getElementById('nome').value = data.nome;
                    document.getElementById('email').value = data.email;
                    document.getElementById('login').value = data.login;
                    document.getElementById('senha').value = data.senha;
                    document.getElementById('perfil').value = data.perfil;
                } else {
                    alert("Aluno não encontrado.");
                    window.location.href = 'aluno_listar.html';
                }
            } catch (error) {
                console.error("Erro ao carregar aluno:", error);
                alert("Erro ao carregar dados.");
            }

            document.getElementById('btnGravar').addEventListener('click', salvarEdicao);

            fetch('../cabecalho.html').then(resp => resp.text()).then(html => document.getElementById('menu').innerHTML = html);
            fetch('../rodape.html').then(resp => resp.text()).then(html => document.getElementById('rodape').innerHTML = html);
        });


        async function salvarEdicao() {
            const nome = document.getElementById('nome').value;
            const login = document.getElementById('login').value;
            const perfil = document.getElementById('perfil').value;
            const email = document.getElementById('email').value;
            const senha = document.getElementById('senha').value;

            if (!nome || !login || !perfil || !email) {
                alert("Preencha todos os campos obrigatórios.");
                return;
            }

            try {
                const docRef = doc(db, "alunos", instrutorId);

                await updateDoc(docRef, {
                    nome: nome,
                    login: login,
                    perfil: perfil,
                    email: email,
                    senha: senha
                });

                alert("Aluno atualizado com sucesso!");
                window.location.href = 'aluno_listar.html';

            } catch (error) {
                console.error("Erro ao salvar alterações:", error);
                alert("Ocorreu um erro ao salvar as alterações.");
            }
        }
    
    </script>
</body>
</html>