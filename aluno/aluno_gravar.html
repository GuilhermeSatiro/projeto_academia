<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Cadastro de alunos</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</head>
<body class="bg-light min-vh-100 d-flex flex-column">
    <div id="menu"></div>

    <main id="principal" class="container-fluid flex-fill d-flex align-items-start justify-content-center py-4">
        <div class="card shadow p-4 w-100">
            <h2 class="mb-4">Gravação de alunos</h2>
            
            <form id="formCadastro">
                <div class="mb-3">
                    <button type="button" class="btn btn-primary me-2" onclick="window.location.href = 'aluno_listar.html'">Voltar</button>
                    <button type="button" id="btnGravar" class="btn btn-success me-2">Gravar</button>
                </div>
                
                <div class="mb-3">
                    <label for="id" class="form-label">ID</label>
                    <input type="text" id="id" name="id" class="form-control" readonly disabled placeholder="Será gerado automaticamente">
                </div>
                
                <div class="mb-3">
                    <label for="nome" class="form-label">Nome completo</label>
                    <input type="text" id="nome" name="nome" class="form-control" required>
                </div>
                <div class="mb-3">
                    <label for="email" class="form-label">Email</label>
                    <input type="email" id="email" name="email" class="form-control" required>
                </div>
                <div class="mb-3">
                    <label for="login" class="form-label">Login (apelido)</label>
                    <input type="text" id="login" name="login" class="form-control" required>
                </div>
                <div class="mb-3">
                    <label for="senha" class="form-label">Senha</label>
                    <input type="password" id="senha" name="senha" class="form-control" required>
                </div>
                <div class="mb-3">
                    <label for="perfil" class="form-label">Pefil de acesso</label>
                    <select id="perfil" name="perfil" class="form-select" required>
                        <option value="">Selecione</option>
                        <option value="Instrutor">Instrutor</option>
                        <option value="Aluno">Aluno</option>
                    </select>
                </div>
            </form>
        </div>
    </main>

    <div id="rodape"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.7/firebase-app.js";

        const firebaseConfig = {
            apiKey: "AIzaSyD9C8wbh4jwaYLHuH5GSAn5hWKxCXjg6Ag",
            authDomain: "trabalho-faculdade-7fee6.firebaseapp.com",
            projectId: "trabalho-faculdade-7fee6",
            storageBucket: "trabalho-faculdade-7fee6.firebasestorage.app",
            messagingSenderId: "681763783199",
            appId: "1:681763783199:web:edd45fdff695a44f310b2a",
            measurementId: "G-F37XKMBDJT"
        };

        const ap = initializeApp(firebaseConfig);

        window.firebaseApp = ap; 
    </script>


    <script type="module">
        import { getAuth, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/9.6.7/firebase-auth.js";
        import { getFirestore, doc, setDoc } from "https://www.gstatic.com/firebasejs/9.6.7/firebase-firestore.js";

        const app = window.firebaseApp;
        const auth = getAuth(app);
        const db = getFirestore(app);

        fetch('../cabecalho.html')
            .then(resp => resp.text())
            .then(html => document.getElementById('menu').innerHTML = html)

        fetch('../rodape.html')
            .then(resp => resp.text())
            .then(html => document.getElementById('rodape').innerHTML = html)


        async function gravarAlunoFirebase() {
            console.log("Iniciando gravação...");

            const nome = document.getElementById('nome').value;
            const email = document.getElementById('email').value;
            const login = document.getElementById('login').value;
            const senha = document.getElementById('senha').value;
            const perfil = document.getElementById('perfil').value;

            if (!nome || !email || !senha || !login || !perfil) {
                alert("Por favor, preencha todos os campos obrigatórios.");
                return;
            }

            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, senha);
                const user = userCredential.user;
                
                console.log("Usuário criado no Auth:", user.uid);

                await setDoc(doc(db, "alunos", user.uid), {
                    nome: nome,
                    login: login,
                    perfil: perfil,
                    email: email 
                });

                console.log("Dados salvos no Firestore!");

                // 5. Dar feedback e redirecionar
                alert("Aluno salvo com sucesso!");
                window.location.href = 'aluno_listar.html'; // Redireciona para a listagem

            } catch (error) {
                // 6. Tratar erros
                console.error("Erro ao salvar aluno:", error);
                
                if (error.code == 'auth/email-already-in-use') {
                    alert("Erro: Este e-mail já está em uso.");
                } else if (error.code == 'auth/weak-password') {
                    alert("Erro: A senha é muito fraca. (Deve ter no mínimo 6 caracteres)");
                } else {
                    alert("Ocorreu um erro: " + error.message);
                }
            }
        }
        
        // Adiciona o "ouvidor de evento" ao botão
        document.getElementById('btnGravar').addEventListener('click', gravarAlunoFirebase);

    </script>

</body>
</html>